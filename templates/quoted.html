{% extends "layout.html" %}

{% block title %}
    Quoted
{% endblock %}

{% block main %}
    <div class="mb-3">
        <h3>
            <b>{{ stock_data.symbol }}</b> ({{ stock_data.name }})
        </h3>
        <h4 id="price">{{ stock_data.price }}</h4>
        <p>As of <span id="current_time">{{ stock_data.current_time }}</span> <a href="#" onclick="refreshQuote('{{ stock_data.symbol }}'); return false;">Update</a></p>

        
        Currently Market is: <b id="market">{{ stock_data.market }}</b>
    </div>

    <h4>Market details</h4>

    <div class="container d-flex flex-row">        
        <div class="container-sm pt-3">
            <table class="table table-hover">          
                <tbody>
                    <tr>
                        <th class="text-start">
                            Previous Close
                        </th>
                        <td>
                            {{ stock_data.previous_close }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Open
                        </th>
                        <td>
                            {{ stock_data.open_price }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Bid
                        </th>
                        <td>
                            <span id="bid_price">{{ stock_data.bid_price }}</span> x <span id="bid_size">{{ stock_data.bid_size }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Ask
                        </th>
                        <td>
                            <span id="ask_price">{{ stock_data.ask_price }}</span> x <span id="ask_size">{{ stock_data.ask_size }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Day High
                        </th>
                        <td id="day_high">
                            {{ stock_data.day_high }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Day Low
                        </th>
                        <td id="day_low">
                            {{ stock_data.day_low }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Currency
                        </th>
                        <td>
                            {{ stock_data.currency }}
                        </td>
                    </tr>                     
                </tbody>
            </table>
        </div>

        <div class="container-sm pt-3">
            <table class="table table-hover">          
                <tbody>
                    <tr>
                        <th class="text-start">
                            Market Cap
                        </th>
                        <td>
                            {{ stock_data.market_cap }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            P/E Ratio
                        </th>
                        <td>
                            {{ stock_data.pe }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            52-week High
                        </th>
                        <td>
                            {{ stock_data.fifty_two_week_high }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            52-week Low
                        </th>
                        <td>
                            {{ stock_data.fifty_two_week_low }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Volume
                        </th>
                        <td>
                            {{ stock_data.volume }}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-start">
                            Average Volume
                        </th>
                        <td>
                            {{ stock_data.average_volume }}
                        </td>
                    </tr>    
                    <tr>
                        <th class="text-start">
                            Yield
                        </th>
                        <td>
                            {{ stock_data.dividend_yield }}
                        </td>
                    </tr>                
                </tbody>
            </table>
        </div>
            
    </div>

    <script>
        <!-- Create refreshQuote function that creates AJAX request to server to get updated stock data -->
        function refreshQuote(symbol) {
            const payload = JSON.stringify({ symbol: symbol });
            console.log("Sending payload:", payload);
    
            fetch('/quote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: payload
            })
            .then(response => {
                console.log("Response status:", response.status);
                if (!response.ok) {
                    return response.json().then(error => { 
                        console.error("Response error content:", error);
                        throw new Error(error.error); 
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Data received:', data); // Log the entire data object
                if (data.error) {
                    console.error('Error refreshing quote:', data.error);
                    return;
                }
                // Update the page content with the new data
                document.getElementById("price").textContent = data.price
                
                
                document.getElementById('current_time').textContent = data.current_time;
                // Log updated current_time
                console.log('Updated current_time:', document.getElementById('current_time').textContent);

                document.getElementById("market").textContent = data.market
                document.getElementById("bid_price").textContent = data.bid_price
                document.getElementById("bid_size").textContent = data.bid_size
                document.getElementById("ask_price").textContent = data.ask_price
                document.getElementById("ask_size").textContent = data.ask_size
                document.getElementById("day_high").textContent = data.day_high
                document.getElementById("day_low").textContent = data.day_low
            })
            .catch(error => {
                console.error('Error refreshing quote:', error);
            });
        }
    </script>

{% endblock %}
